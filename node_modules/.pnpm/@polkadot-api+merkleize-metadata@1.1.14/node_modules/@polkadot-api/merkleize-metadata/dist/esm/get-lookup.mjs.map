{"version":3,"file":"get-lookup.mjs","sources":["../../src/get-lookup.ts"],"sourcesContent":["import { Lookup, LookupValue, ScalePrimitive, TypeDef, TypeRef } from \"./codecs\"\n\nconst bitSequenceBytes = {\n  u8: 1,\n  u16: 2,\n  u32: 4,\n  u64: 8,\n}\n\nconst constructTypeDef = (\n  definitions: Map<number, LookupValue>,\n  getTypeRef: (frameId: number) => TypeRef,\n  getPrimitive: (frameId: number) => ScalePrimitive[\"tag\"] | null,\n  frameId: number,\n): TypeDef[] => {\n  const {\n    def: { tag, value },\n  } = definitions.get(frameId)!\n  switch (tag) {\n    case \"composite\":\n      return [\n        {\n          tag,\n          value: value.map((f) => ({\n            name: f.name,\n            typeName: f.typeName,\n            ty: getTypeRef(f.type),\n          })),\n        },\n      ]\n    case \"variant\": {\n      return value.map((v) => ({\n        tag: \"enumeration\",\n        value: {\n          name: v.name,\n          index: v.index,\n          fields: v.fields.map((f) => ({\n            name: f.name,\n            typeName: f.typeName,\n            ty: getTypeRef(f.type),\n          })),\n        },\n      }))\n    }\n    case \"sequence\":\n      return [\n        {\n          tag,\n          value: getTypeRef(value),\n        },\n      ]\n    case \"array\":\n      return [\n        {\n          tag,\n          value: {\n            len: value.len,\n            typeParam: getTypeRef(value.type),\n          },\n        },\n      ]\n    case \"tuple\":\n      return [\n        {\n          tag,\n          value: value.map(getTypeRef),\n        },\n      ]\n    case \"bitSequence\": {\n      const primitive = getPrimitive(value.bitStoreType)\n      const numBytes = bitSequenceBytes[primitive as \"u8\"]\n      if (!numBytes) throw new Error(\"Invalid primitive for BitSequence\")\n\n      const storeOrderPath = definitions.get(value.bitOrderType)!.path\n      const leastSignificantBitFirst = storeOrderPath.includes(\"Lsb0\")\n      if (!leastSignificantBitFirst && !storeOrderPath.includes(\"Msb0\"))\n        throw new Error(\"BitOrderType not recognized\")\n\n      return [\n        {\n          tag: \"bitSequence\",\n          value: { numBytes, leastSignificantBitFirst },\n        },\n      ]\n    }\n  }\n\n  throw new Error(`FrameId(${frameId}) should have been filtered out`)\n}\n\nexport const getLookup = (\n  definitions: Map<number, LookupValue>,\n  accessibleTypes: Map<number, number>,\n  getTypeRef: (frameId: number) => TypeRef,\n  getPrimitive: (frameId: number) => ScalePrimitive[\"tag\"] | null,\n) => {\n  const typeTree: Lookup = []\n  ;[...accessibleTypes.entries()].forEach(([frameId, typeId]) => {\n    const { path } = definitions.get(frameId)!\n    constructTypeDef(definitions, getTypeRef, getPrimitive, frameId).forEach(\n      (typeDef) => {\n        typeTree.push({\n          path,\n          typeId,\n          typeDef,\n        })\n      },\n    )\n  })\n\n  typeTree.sort((a, b) => {\n    if (a.typeId !== b.typeId) return a.typeId - b.typeId // in general\n    // should only happen for variants\n    if (a.typeDef.tag !== \"enumeration\" || b.typeDef.tag !== \"enumeration\")\n      throw new Error(\"Found two types with same id\")\n    return a.typeDef.value.index - b.typeDef.value.index\n  })\n  return typeTree\n}\n"],"names":[],"mappings":"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"}